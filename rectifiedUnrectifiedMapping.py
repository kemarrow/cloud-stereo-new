# -*- coding: utf-8 -*-
"""
Created on Sat Nov 13 17:40:55 2021

takes a series of matching coordinates from the rectified and unrectified 
camera 1 images (have been using 10/03/2021 12pm frame 1) to calculate the
homography between the two so that we can map the lidar positions onto the 
depth map.

@author: kathe
"""

import numpy as np
import cv2 as cv
import matplotlib.pyplot as plt

from lidarCameraMatching import lidar_coords, camera_coords, transform

def lidarToRectified(lidar, H_L, H_C):
    z = []
    for point in list(lidar):
        point = np.append(point, [1])
        z.append(point)
    newmap = []
    for p in z:
        val = np.matmul(H_L, p)
        val[0] = val[0]/val[2]
        val[1] = val[1]/val[2]
        newval = np.array([val[0], val[1], 1])
        rectval = np.matmul(H_C, newval)
        rectval[0] = rectval[0]/rectval[2]
        rectval[1] = rectval[1]/rectval[2]
        newmap.append(rectval)
    return np.array(newmap)

def unrectifiedToRectified(coords, mat):
    z = []
    for point in list(coords):
        point = np.append(point, [1])
        z.append(point)
    newmap = []
    for p in z:
        val = np.matmul(mat, p)
        val[0] = val[0]/val[2]
        val[1] = val[1]/val[2]
        newmap.append(val)
    newmap = np.array(newmap)
    return newmap 

def lidarToRectifiedSingle(lidar, H_L, H_C):
    z = np.append(lidar, [1])
    val = np.matmul(H_L, z)
    val[0] = val[0]/val[2]
    val[1] = val[1]/val[2]
    newval = np.array([val[0], val[1], 1])
    rectval = np.matmul(H_C, newval)
    rectval[0] = rectval[0]/rectval[2]
    rectval[1] = rectval[1]/rectval[2]
    return rectval
    
       
#%% # coords for 03/10/2021 12pm
# rect_coords = np.array([(546.7862437227254, 135.45849213833037),
#  (601.1289116466745, 162.62982610030485),
#  (560.3719107037127, 198.44658450472582),
#  (624.5950637047434, 303.4267384487183),
#  (625.8301243393786, 318.24746606434076),
#  (591.2484265695929, 331.83313304532805),
#  (550.4914256266311, 354.0642244687617),
#  (515.9097278568453, 297.25143527554235),
#  (350.41160281572775, 392.35110414245315),
#  (375.11281550843194, 450.3989539703078),
#  (307.18448060349556, 461.5144996820246),
#  (536.9057586456438, 115.69752198416711),
#  (302.24423806495474, 110.7572794456263),
#  (357.82196662353897, 220.6776759281596),
#  (418.3399377206641, 309.6020416218944),
#  (99.69429398478104, 135.45849213833037),
#  (278.77808600688587, 35.418580732878695),
#  (205.90950856340874, 65.0600359641237),
#  (184.91347777461021, 84.82100611828696),
#  (235.55096379465368, 150.27921975395282),
#  (297.3039955264139, 429.4029231815093),
#  (105.86959715795706, 384.9407403346419),
#  (362.7622091620798, 421.99255937369804),
#  (444.27621104800335, 140.3987346768712),
#  (471.44754500997794, 293.5462533716367),
#  (359.05702725817423, 219.44261529352434),
#  (213.31987237121996, 209.5621302164427),
#  (325.71039012302367, 278.72552575601424)])

# unrect_coords = np.array([(567.5519480519482, 249.3701298701298),
#  (610.4090909090911, 294.82467532467524),
#  (551.9675324675326, 313.0064935064935),
#  (561.0584415584417, 462.35714285714283),
#  (554.5649350649352, 479.2402597402597),
#  (502.6168831168833, 468.8506493506493),
#  (454.5649350649352, 466.25324675324674),
#  (444.17532467532476, 401.31818181818176),
#  (244.17532467532473, 394.8246753246753),
#  (237.68181818181822, 462.35714285714283),
#  (167.55194805194807, 437.68181818181813),
#  (563.6558441558443, 211.70779220779212),
#  (327.2922077922078, 102.616883116883),
#  (329.8896103896104, 231.18831168831161),
#  (340.27922077922085, 342.87662337662334),
#  (140.27922077922082, 46.772727272727195),
#  (342.87662337662346, 20.79870129870119),
#  (259.7597402597403, 20.79870129870119),
#  (236.3831168831169, 33.78571428571422),
#  (250.66883116883125, 113.00649350649343),
#  (177.9415584415585, 394.8246753246753),
#  (45.474025974026006, 264.9545454545454),
#  (238.98051948051952, 424.69480519480516),
#  (450.6688311688313, 198.72077922077915),
#  (400.01948051948057, 358.4610389610389),
#  (328.5909090909091, 229.8896103896103),
#  (205.21428571428575, 158.46103896103887),
#  (268.8506493506494, 268.8506493506493)])
#%% # coords for 04/10/2021 11am
# unrect_coords = np.array([(566.2532467532469, 249.3701298701298),
#  (607.8116883116885, 297.42207792207785),
#  (549.37012987013, 310.4090909090909),
#  (561.0584415584417, 462.35714285714283),
#  (445.47402597402606, 400.01948051948045),
#  (242.87662337662343, 392.2272727272727),
#  (237.68181818181822, 461.05844155844153),
#  (205.21428571428575, 455.8636363636363),
#  (189.62987012987017, 450.66883116883116),
#  (167.55194805194807, 436.3831168831168),
#  (325.9935064935065, 203.91558441558436),
#  (368.8506493506494, 184.43506493506487),
#  (571.4480519480521, 89.62987012987003),
#  (477.9415584415585, 363.6558441558441),
#  (537.6818181818184, 346.77272727272725),
#  (449.37012987013, 432.4870129870129),
#  (184.43506493506496, 211.70779220779212),
#  (176.6428571428572, 419.5),
#  (425.99350649350663, 93.52597402597394),
#  (392.22727272727286, 124.6948051948051),
#  (202.61688311688314, 353.2662337662337),
#  (158.461038961039, 340.27922077922074),
#  (23.39610389610391, 179.24025974025966),
#  (341.57792207792215, 366.2532467532467),
#  (451.9675324675326, 51.96753246753235),
#  (348.07142857142867, 71.44805194805184),
#  (597.4220779220781, 285.7337662337662),
#  (520.7987012987014, 413.0064935064935),
#  (459.7597402597404, 374.0454545454545),
#  (120.79870129870133, 64.95454545454538)])

# rect_coords = np.array([(511.295354086335, 158.34104203893537),
#  (570.8834289476159, 187.47298974889492),
#  (521.8887896172293, 227.19837298974886),
#  (585.4494028025957, 339.75362550550176),
#  (466.2732530800339, 325.18765165052196),
#  (295.45410514436185, 399.3417003667827),
#  (313.9926173234271, 457.60559578670177),
#  (288.83320793755286, 465.5506724348726),
#  (274.2672340825731, 468.19903131759617),
#  (253.08036302078432, 457.60559578670177),
#  (303.39918179253266, 204.6873224865983),
#  (333.8553089438541, 172.90701589391517),
#  (474.2183297282046, 14.005482930499397),
#  (486.13594470046087, 290.7589861751152),
#  (532.4822251481238, 253.68196181698488),
#  (484.81176525909905, 358.2921376845669),
#  (182.898852628609, 264.2753973478792),
#  (251.75618357942255, 445.6879808144456),
#  (348.4212827988338, 72.26937835041849),
#  (328.5585911784068, 109.3464027085488),
#  (247.78364525533715, 378.1548293049939),
#  (206.73408257312138, 387.42408539452646),
#  (33.266575754725864, 300.0282422646478),
#  (372.2565127433462, 345.05034327094893),
#  (359.0147183297282, 24.598918461393737),
#  (276.9155929652967, 73.59355779178031),
#  (554.9932756512743, 184.82463086617133),
#  (537.778942913571, 319.8909338850748),
#  (472.8941502868429, 307.97331891281857),
#  (72.99195899557981, 168.93447756982977)])
#%% #coords for 24/10/2021 12pm frame 2 with new rectification
rect_coords = np.array([(604.0188284518828, 198.2112970711297),
 (549.7928870292886, 226.32845188284523),
 (549.123430962343, 164.0690376569038),
 (593.3075313807531, 226.99790794979083),
 (617.407949790795, 374.27824267782427),
 (595.9853556485356, 368.2531380753138),
 (541.0899581589958, 393.0230125523012),
 (496.90585774058576, 404.4037656903766),
 (472.8054393305439, 343.4832635983264),
 (271.2991631799163, 391.68410041841),
 (284.0188284518828, 454.61297071129707),
 (405.85983263598325, 362.22803347280336),
 (377.7426778242678, 369.592050209205),
 (354.9811715481171, 423.81799163179915),
 (225.10669456066944, 463.31589958159),
 (213.05648535564853, 447.2489539748954),
 (209.03974895397488, 467.3326359832636),
 (154.14435146443515, 469.3410041841004),
 (67.11506276150627, 451.93514644351467),
 (190.2949790794979, 328.0857740585774),
 (342.2615062761506, 291.26569037656907),
 (215.06485355648533, 78.37866108786613),
 (223.09832635983264, 8.085774058577385),
 (62.42887029288703, 172.10251046025104),
 (383.09832635983264, 75.03138075313808),
 (413.8933054393305, 235.03138075313808),
 (588.6213389121339, 166.7468619246862),
 (22.930962343096233, 211.60041841004187),
 (185.60878661087867, 374.94769874476987),
 (117.32426778242677, 236.37029288702928)])

unrect_coords = np.array([(609.3744769874477, 295.28242677824267),
 (548.4539748953974, 308.6715481171548),
 (565.8598326359833, 246.4121338912134),
 (592.6380753138075, 321.39121338912133),
 (579.2489539748954, 471.3493723849372),
 (560.5041841004183, 459.9686192468619),
 (500.2531380753138, 468.00209205020917),
 (453.39121338912133, 468.00209205020917),
 (444.6882845188284, 401.05648535564853),
 (241.8430962343096, 392.3535564853556),
 (236.48744769874475, 459.9686192468619),
 (375.06485355648533, 400.38702928870293),
 (348.28661087866107, 399.71757322175733),
 (311.4665271966527, 449.2573221757322),
 (176.23640167364016, 455.95188284518827),
 (168.87238493723848, 435.86820083682005),
 (158.16108786610877, 455.95188284518827),
 (103.93514644351464, 443.90167364016736),
 (22.930962343096233, 405.0732217573222),
 (182.2615062761506, 312.6882845188285),
 (333.5585774058577, 314.6966527196653),
 (269.96025104602506, 82.39539748953979),
 (293.39121338912133, 15.449790794979094),
 (95.90167364016736, 127.91841004184101),
 (426.61297071129707, 122.56276150627616),
 (413.2238493723849, 280.55439330543936),
 (603.3493723849372, 260.47071129707115),
 (46.36192468619247, 154.02719665271968),
 (162.84728033472803, 355.5334728033473),
 (134.06066945606693, 204.90585774058582)])
#%%


cameraH, _ = cv.findHomography(unrect_coords, rect_coords,cv.FM_RANSAC)

for point in camera_coords:
    point = np.array([point])
    
cam_coords_new = transform(camera_coords, cameraH)
print(cam_coords_new)
print(cameraH)

new_rect = transform(unrect_coords, cameraH)

fp = r"C:\Users\kathe\OneDrive - Imperial College London\MSci Project\rectifiedC1forLidarCalibration.png"
im = cv.imread(fp)

fig, ax = plt.subplots(1,1)
ax.imshow(im)
ax.plot(rect_coords[:,0], rect_coords[:,1], 'rx', label = 'from rectified image')
ax.plot(new_rect[:,0], new_rect[:,1], 'yx', label = 'transformed to rectified image')
ax.legend()
